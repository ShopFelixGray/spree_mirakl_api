SpreeMiraklApi
==============

Spree intergration for Mirakl API. Currently only processes orders and brings them into the system and allows you to ship.
Each Mirakl Store Requires a user to be assigned to it. All orders from that store will be placed under that user.

## Installation

1. Add this extension to your Gemfile with this line:
  ```ruby
  gem 'spree_mirakl_api', github: '[your-github-handle]/spree_mirakl_api', branch: 'X-X-stable'
  ```

  The `branch` option is important: it must match the version of Spree you're using.
  For example, use `3-1-stable` if you're using Spree `3-1-stable` or any `3.1.x` version.

2. Install the gem using Bundler:
  ```ruby
  bundle install
  ```

3. Copy & run migrations
  ```ruby
  bundle exec rails g spree_mirakl_api:install
  ```

4. Restart your server

  If your server was running, restart it so that it can find the assets properly.

## Setup Cron Jobs

To pull in the orders a cron job is required. There is 3 different services that should be run separately of each other.

1. Mirakl::OrderProcessing.new(stores: Spree::MiraklStore.active)

  This service gets all orders waiting acceptance and checks if they can be fully accepted. If one line item cant be meet the whole order is rejected. An example worker for this would be

  ```def perform
    service = Mirakl::OrderProcessing.new(stores: Spree::MiraklStore.active)
    unless service.call
      logger.debug service.errors
      Rollbar.error(Exception.new(service.errors.to_s))
    end
  end
  ```

  Service.errors will return an array of errors and call will return false if there is any errors

2. Mirakl::GetShippingOrders.new({stores: Spree::MiraklStore.active})

  This service takes all orders that are ready to be shipped and pulls them into spree. An example worker for this would be 

  ```def perform
    service = Mirakl::GetShippingOrders.new({stores: Spree::MiraklStore.active})
    unless service.call
      logger.debug service.errors
      Rollbar.error(Exception.new(service.errors.to_s))
    end
  end
  ```

3. Mirakl::UpdateInventory.new({store: store})

  This service syncs a single stores inventory. It takes a single store because it is reused on index. It will use the spree call total_on_hand for a given sku to update Mirakls offerings. An example for a worker would be

  ```def perform
    Spree::MiraklStore.active.each do |store|
      service = Mirakl::UpdateInventory.new({store: store})
      unless service.call
        raise Exception.new("Issue with updating inventory for store: #{store.shop_id}")
      end
    end
  end
  ```

## Testing

First bundle your dependencies, then run `rake`. `rake` will default to building the dummy app if it does not exist, then it will run specs. The dummy app can be regenerated by using `rake test_app`.

```shell
bundle
bundle exec rake
```

When testing your applications integration with this extension you may use it's factories.
Simply add this require statement to your spec_helper:

```ruby
require 'spree_mirakl_api/factories'
```


## Contributing

If you'd like to contribute, please take a look at the
[instructions](CONTRIBUTING.md) for installing dependencies and crafting a good
pull request.

Copyright (c) 2020 Felix Gray, released under the New BSD License
